# Generated by Django 3.2.16 on 2022-12-14 09:28

from django.db import migrations, models

# Separate state and database changes in migration to avoid downtime.
# For next release will be prepared migration to remove the field from database.

# Database fields in this migration are changed to null to allow adding new rows.
# To reverse that operation, we will set all values for `SiteSettings` regarding the
# first channel in alphabetical order.


def update_order_settings_values_to_match_first_channel(apps, schema_editor):
    SiteSettings = apps.get_model("site", "SiteSettings")
    Channel = apps.get_model("channel", "Channel")

    channel = Channel.objects.filter(is_active=True).order_by("slug").first()

    if channel:
        SiteSettings.objects.update(
            automatically_confirm_all_new_orders=(
                channel.automatically_confirm_all_new_orders
            ),
            automatically_fulfill_non_shippable_gift_card=(
                channel.automatically_fulfill_non_shippable_gift_card
            ),
        )
    else:
        SiteSettings.objects.update(
            automatically_confirm_all_new_orders=True,
            automatically_fulfill_non_shippable_gift_card=True,
        )


class Migration(migrations.Migration):

    dependencies = [
        ("site", "0034_sitesettings_limit_quantity_per_checkout"),
        ("channel", "0008_update_null_order_settings"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.AlterField(
                    model_name="sitesettings",
                    name="automatically_fulfill_non_shippable_gift_card",
                    field=models.BooleanField(null=True, blank=True),
                ),
                migrations.AlterField(
                    model_name="sitesettings",
                    name="automatically_confirm_all_new_orders",
                    field=models.BooleanField(null=True, blank=True),
                ),
                migrations.RunPython(
                    migrations.RunPython.noop,
                    update_order_settings_values_to_match_first_channel,
                ),
            ],
            state_operations=[
                migrations.RemoveField(
                    model_name="sitesettings",
                    name="automatically_fulfill_non_shippable_gift_card",
                ),
                migrations.RemoveField(
                    model_name="sitesettings",
                    name="automatically_confirm_all_new_orders",
                ),
            ],
        )
    ]
